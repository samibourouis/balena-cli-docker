image: docker:latest

stages:
  - build-docker
  - publish-git

# Build Docker & deploy to Docker Hub
build_docker:dockerhub:
  image: docker:latest
  stage: build-docker
  tags:
    - buildx
  only:
    - master
  cache: {}
  variables:
    DOCKERFILE: Dockerfile
    IMAGE_TAG: samibourouis/balena-cli
  before_script:
    - docker info
    - docker buildx version
    - docker login -u ${DOCKER_HUB_USERNAME} -p ${DOCKER_HUB_PASSWORD}
  script:
    - docker buildx use gitlab-runner-builder
    - docker buildx inspect --bootstrap
    - docker buildx build --no-cache --platform linux/amd64 -t ${IMAGE_TAG}:latest -f ${DOCKERFILE} ${DOCKER_BUILD_ARGS} . --push
    - BALENA_CLI_VERSION=`docker run -i ${IMAGE_TAG}:latest balena version`
    - docker tag ${IMAGE_TAG}:latest ${IMAGE_TAG}:$BALENA_CLI_VERSION
    - docker push ${IMAGE_TAG}:$BALENA_CLI_VERSION

# Publish to Github
github_mirror:
  stage: publish-git
  image:
    name: alpine/git
    entrypoint: [ "/bin/sh", "-c" ]
  only:
    - master
  variables:
    GIT_STRATEGY: clone
    GIT_CHECKOUT: "false"
  script: |
    cd /tmp
    git clone --mirror ${CI_REPOSITORY_URL} project
    cd project
    git remote add github https://${GITHUB_USER}:${GITHUB_TOKEN}@github.com/samibourouis/balena-cli-docker.git
    git push --mirror github
